# https://taskfile.dev

version: '3'

set:
  - "errexit"
  - "nounset"
  - "pipefail"

includes:
  demo: ./tasks/Taskfile.demo.yml
  vcluster: 
    taskfile: ./tasks/Taskfile.vcluster.yml
    internal: true
  tools: 
    taskfile: ./tasks/Taskfile.tools.yml
    internal: true

tasks:
  install-tools:
    cmds:
      - task: tools:install

  linkerd-install:
    desc: uses the linkerd cli to deploy linkerd and its viz component and injects the proxy into podinfo
    cmds:
      - linkerd install --crds | kubectl apply -f -
      - linkerd install --set proxyInit.runAsRoot=true | kubectl apply -f -
      - linkerd viz install | kubectl apply -f -
      - linkerd check

  linkerd-inject:
    desc: injects the linkerd proxy in podinfo
    cmds:
      - kubectl get deployment podinfo -n podinfo -o yaml | linkerd inject - | kubectl apply -f -
      - kubectl rollout status deployment/podinfo -n podinfo

  linkerd-edges:
    desc: lists edges known by linkerd
    cmds:
      - linkerd viz edges deployments --all-namespaces

  linkerd-top:
    desc: runs linkerd top to watch for route stats
    cmds:
      - linkerd viz top -n podinfo deployment/podinfo

  linkerd-tap:
    desc: runs linkerd top to log requests
    cmds:
      - linkerd viz tap -n podinfo deployment/podinfo

  create-env:
    desc: "Create the vcluster"
    deps:
      - task: tools:ensure-kubectl
    cmds:
      - task: vcluster:create
      - task: vcluster:expose

  list-env:
    desc: "List all vclusters"
    cmds:
      - task: vcluster:list

  delete-env:
    desc: "Destroy the vcluster"
    cmds:
      - task: vcluster:delete 

  deploy-app:
    desc: "Deploy the application"
    deps:
      - task: tools:ensure-kubectl
      - task: tools:ensure-helm
      - task: tools:ensure-kustomize
      - task: tools:ensure-skaffold
    cmds:
      - task: vcluster:connect
      - defer: { task: vcluster:disconnect }

      - task: set-domain
        vars:
          PREVIEW_DOMAIN: '{{.PREVIEW_DOMAIN | default "otel-demo.localhost"}}'
          PREVIEW_ENVIRONMENT_PATH: opentelemetry-demo/preview

      - cmd: skaffold deploy --status-check=false -m opentelemetry-demo

  set-domain:
    internal: true
    deps:
      - task: tools:ensure-kustomize
    dir: "{{.PREVIEW_ENVIRONMENT_PATH}}"
    preconditions:
      - sh: test -n "{{.PREVIEW_DOMAIN}}"
        msg: Please set the PREVIEW_DOMAIN variable.
      - sh: test -n "{{.PREVIEW_ENVIRONMENT_PATH}}"
    cmds:
      - kustomize edit set annotation preview/domain:"{{.PREVIEW_DOMAIN}}"

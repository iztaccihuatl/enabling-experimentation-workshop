apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
data:
  context: |
    previewDomain: edgecase.rio.wtf

  service.github: |
    appID: 383353
    installationID: 41276697
    privateKey: $github-private-key

  template.app-deployed: |
    message: |
      Application is now running.
    github:
      repoURLPath: "{{.app.spec.source.repoURL}}"
      revisionPath: "{{.app.status.operationState.syncResult.revision}}"
      status:
        state: success
        label: "app/{{.app.metadata.name}}"
        targetURL: 'http://{{index .app.metadata.labels "preview/env"}}.{{.context.previewDomain}}/'

  template.app-created: |
    message: |
      Application has been created and is pending sync.
    github:
      repoURLPath: "{{.app.spec.source.repoURL}}"
      revisionPath: "{{.app.status.operationState.syncResult.revision}}"
      status:
        state: pending
        label: "app/{{.app.metadata.name}}"

  template.app-created: |
    message: |
      Application is syncing.
    github:
      repoURLPath: "{{.app.spec.source.repoURL}}"
      revisionPath: "{{.app.status.operationState.syncResult.revision}}"
      status:
        state: pending
        label: "app/{{.app.metadata.name}}"

  trigger.on-deployed: |
    - description: Application is synced and healthy. Triggered once per commit.
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
      oncePer: app.status.operationState.syncResult.revision
      send: [app-deployed]

  trigger.on-created: |
    - description: Application is created. Triggered once per app.
      when: true
      oncePer: app.metadata.name
      send: [app-created]

  trigger.on-syncing: |
    - description: Application is syncing. Triggered once per commit.
      when: app.status.operationState != nil and app.status.operationState.phase in ['Running']
      send: [app-syncing]

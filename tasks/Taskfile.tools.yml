# https://taskfile.dev

version: '3'

tasks:
  install:
    silent: true
    cmds:
      - mkdir -p .bin
      - task: ensure-kubectl
      - task: ensure-vcluster
      - task: ensure-linkerd

  symlink:
    dir: .bin
    cmds:
      - sudo ln -s kubectl /usr/local/bin/kubectl
      - sudo ln -s vcluster /usr/local/bin/vcluster
      - sudo ln -s linkerd /usr/local/bin/linkerd

  ensure-kubectl:
    silent: true
    status:
      - command -v kubectl
    dir: .bin
    cmds:
      - curl -sSfLO "https://dl.k8s.io/release/$(curl -sSfL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x kubectl

  ensure-vcluster:
    silent: true
    status:
      - command -v vcluster
    dir: .bin
    cmds:
      - curl -sSfLo vcluster "https://github.com/loft-sh/vcluster/releases/download/v0.15.7/vcluster-linux-amd64"
      - chmod +x vcluster

  ensure-linkerd:
    silent: true
    status:
      - command -v linkerd
    dir: .bin
    cmds:
      - curl -sSfLo linkerd https://github.com/linkerd/linkerd2/releases/download/stable-2.14.0/linkerd2-cli-stable-2.14.0-linux-amd64
      - chmod +x linkerd

  ensure-figlet:
    silent: true
    status:
      - command -v figlet
    cmds:
      - sudo apt-get -qq update > /dev/null
      - sudo apt-get -qqy install figlet > /dev/null

  ensure-qrencode:
    silent: true
    status:
      - command -v qrencode
    cmds:
      - sudo apt-get -qq update > /dev/null
      - sudo apt-get -qqy install qrencode > /dev/null

  ensure-slides:
    silent: true
    dir: ../slides
    status:
      - test -f ./bin/slides
    cmds:
      - curl -sSfLo slides.tar.gz https://github.com/maaslalani/slides/releases/download/v0.9.0/slides_0.9.0_linux_amd64.tar.gz
      - defer: rm slides.tar.gz
      - tar xf slides.tar.gz slides
      - mkdir -p ./bin/
      - chmod +x slides
      - mv slides ./bin/

  ensure-slides-dependencies:
    silent: true
    cmds:
      - task: ensure-slides
      - task: ensure-qrencode
      - task: ensure-figlet

  ensure-gitea-remote:
    silent: true
    status:
      - git remote -v | grep gitea
    cmds:
      - git remote add gitea http://root:demopassword@gitea.localhost/root/demo.git

  ensure-jq:
    silent: true
    status:
      - command -v jq
    cmds:
      - apt-get -qq update > /dev/null
      - apt-get -qqy install jq > /dev/null
